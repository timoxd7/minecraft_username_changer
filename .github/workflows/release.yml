name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # First job: Create a new tag
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.create_tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and create new one
        id: create_tag
        run: |
          # Get the latest tag that matches our pattern
          latest_tag=$(git tag -l 'v[0-9]*' | sort -t 'v' -k2 -n | tail -1)
          
          if [ -z "$latest_tag" ]; then
            # No tags exist yet, start with v1
            new_version=1
          else
            # Extract the number and increment
            current_version=${latest_tag#v}
            new_version=$((current_version + 1))
          fi
          
          new_tag="v${new_version}"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Creating new tag: $new_tag"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push the tag
          git tag -a "$new_tag" -m "Release $new_tag"
          git push origin "$new_tag"

  # Build job using matrix strategy
  build:
    needs: create-tag
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build-cmd: flutter build linux --release
            artifact-path: build/linux/x64/release/bundle
            artifact-name: minecraft_username_changer-linux
          - os: windows-latest
            platform: windows
            build-cmd: flutter build windows --release
            artifact-path: build/windows/x64/runner/Release
            artifact-name: minecraft_username_changer-windows
          - os: macos-latest
            platform: macos
            build-cmd: flutter build macos --release
            artifact-path: build/macos/Build/Products/Release
            artifact-name: minecraft_username_changer-macos

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Enable desktop support
        run: flutter config --enable-${{ matrix.platform }}-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build
        run: ${{ matrix.build-cmd }}

      - name: Archive Linux build
        if: matrix.platform == 'linux'
        run: |
          cd ${{ matrix.artifact-path }}
          tar -czvf ${{ github.workspace }}/${{ matrix.artifact-name }}.tar.gz *

      - name: Archive Windows build
        if: matrix.platform == 'windows'
        run: |
          cd ${{ matrix.artifact-path }}
          Compress-Archive -Path * -DestinationPath ${{ github.workspace }}/${{ matrix.artifact-name }}.zip

      - name: Archive macOS build
        if: matrix.platform == 'macos'
        run: |
          cd ${{ matrix.artifact-path }}
          zip -r ${{ github.workspace }}/${{ matrix.artifact-name }}.zip *.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ${{ matrix.artifact-name }}.tar.gz
            ${{ matrix.artifact-name }}.zip

  # Release job: Create release and upload artifacts
  release:
    needs: [create-tag, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag }}
          name: Release ${{ needs.create-tag.outputs.new_tag }}
          body: |
            Automated release ${{ needs.create-tag.outputs.new_tag }}
            
            ## Downloads
            - **Windows**: `minecraft_username_changer-windows.zip`
            - **Linux**: `minecraft_username_changer-linux.tar.gz`
            - **macOS**: `minecraft_username_changer-macos.zip`
          draft: false
          prerelease: false
          files: |
            artifacts/minecraft_username_changer-linux/*.tar.gz
            artifacts/minecraft_username_changer-windows/*.zip
            artifacts/minecraft_username_changer-macos/*.zip

  # Cleanup job: Delete artifacts after release
  cleanup:
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            minecraft_username_changer-linux
            minecraft_username_changer-windows
            minecraft_username_changer-macos
