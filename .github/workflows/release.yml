name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  # First job: Create a new tag
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.create_tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and create new one
        id: create_tag
        run: |
          # Get the latest tag that matches our pattern (using version sort for proper ordering)
          latest_tag=$(git tag -l 'v[0-9]*' | sort -V | tail -1)
          
          if [ -z "$latest_tag" ]; then
            # No tags exist yet, start with v1
            new_version=1
          else
            # Extract the number and increment
            current_version=${latest_tag#v}
            new_version=$((current_version + 1))
          fi
          
          new_tag="v${new_version}"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Creating new tag: $new_tag"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push the tag
          git tag -a "$new_tag" -m "Release $new_tag"
          git push origin "$new_tag"

  # Build job using matrix strategy
  build:
    needs: create-tag
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build-cmd: flutter build linux --release
            artifact-path: build/linux/x64/release/bundle
            artifact-name: minecraft_username_changer-linux
          - os: windows-latest
            platform: windows
            build-cmd: flutter build windows --release
            artifact-path: build/windows/x64/runner/Release
            artifact-name: minecraft_username_changer-windows
          - os: macos-latest
            platform: macos
            build-cmd: flutter build macos --release
            artifact-path: build/macos/Build/Products/Release
            artifact-name: minecraft_username_changer-macos

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Enable desktop support
        run: flutter config --enable-${{ matrix.platform }}-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build
        run: ${{ matrix.build-cmd }}

      - name: Archive Linux build
        if: matrix.platform == 'linux'
        run: |
          cd ${{ matrix.artifact-path }}
          tar -czvf ${{ github.workspace }}/${{ matrix.artifact-name }}.tar.gz *

      - name: Archive Windows build
        if: matrix.platform == 'windows'
        run: |
          cd ${{ matrix.artifact-path }}
          Compress-Archive -Path * -DestinationPath ${{ github.workspace }}/${{ matrix.artifact-name }}.zip

      - name: Archive macOS build
        if: matrix.platform == 'macos'
        run: |
          cd ${{ matrix.artifact-path }}
          zip -r ${{ github.workspace }}/${{ matrix.artifact-name }}.zip *.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ${{ matrix.artifact-name }}.tar.gz
            ${{ matrix.artifact-name }}.zip

  # Release job: Create release and upload artifacts
  release:
    needs: [create-tag, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for generating changelog

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate Changelog
        id: changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e  # Exit on error
          
          # Determine the previous tag using version sort
          # Check tag count to properly handle first release scenario
          tag_count=$(git tag -l 'v[0-9]*' | wc -l | tr -d ' ')
          if [ "$tag_count" -le 1 ]; then
            previous_tag=""
          else
            previous_tag=$(git tag -l 'v[0-9]*' | sort -V | tail -2 | head -1)
          fi
          new_tag="${{ needs.create-tag.outputs.new_tag }}"
          
          echo "Previous tag: $previous_tag"
          echo "New tag: $new_tag"
          
          # Initialize changelog file
          printf '%s\n' "## What's Changed" > changelog.md
          
          # Function to fetch PRs with error handling
          fetch_prs() {
            local search_args="$1"
            local result
            local exit_code
            
            if [ -n "$search_args" ]; then
              result=$(gh pr list --state merged --search "$search_args" --json number,title,author --limit 500 2>&1) && exit_code=0 || exit_code=$?
            else
              result=$(gh pr list --state merged --json number,title,author --limit 500 2>&1) && exit_code=0 || exit_code=$?
            fi
            
            if [ $exit_code -ne 0 ]; then
              echo "::warning::Failed to fetch PRs: $result" >&2
              echo "[]"
              return 0
            fi
            
            # Validate JSON
            if ! echo "$result" | jq empty 2>/dev/null; then
              echo "::warning::Invalid JSON response from gh pr list" >&2
              echo "[]"
              return 0
            fi
            
            echo "$result"
            return 0
          }
          
          # Fetch PRs based on whether this is the first release
          if [ -z "$previous_tag" ]; then
            echo "First release, getting all merged PRs"
            prs=$(fetch_prs "")
          else
            echo "Getting PRs merged after $previous_tag"
            previous_date=$(git log -1 --format=%aI "$previous_tag" 2>/dev/null || echo "")
            
            if [ -n "$previous_date" ]; then
              # Use merged:> (strictly greater than) to exclude PRs from previous release
              prs=$(fetch_prs "merged:>$previous_date")
            else
              echo "::warning::Could not get date for previous tag, fetching all PRs"
              prs=$(fetch_prs "")
            fi
          fi
          
          # Parse PRs and build changelog
          pr_count=$(echo "$prs" | jq 'length' 2>/dev/null || echo "0")
          
          if [ "$pr_count" -ge 500 ]; then
            echo "::warning::PR limit of 500 reached. Some PRs may be omitted from changelog."
          fi
          
          if [ "$pr_count" -gt 0 ]; then
            # Use jq to safely format each PR entry, escaping markdown special characters
            echo "$prs" | jq -r '.[] | "* " + (.title | gsub("[\\[\\]`*_]"; "\\\(.)")) + " by @" + .author.login + " in #" + (.number | tostring)' >> changelog.md 2>/dev/null || {
              echo "::warning::Failed to format PRs with jq, using simple format"
              echo "$prs" | jq -r '.[] | "* " + .title + " by @" + .author.login + " in #" + (.number | tostring)' >> changelog.md
            }
          else
            printf '%s\n' "* Direct commits to main branch" >> changelog.md
          fi
          
          # Add downloads section
          printf '\n%s\n' "## Downloads" >> changelog.md
          printf '%s\n' "- **Windows**: \`minecraft_username_changer-windows.zip\`" >> changelog.md
          printf '%s\n' "- **Linux**: \`minecraft_username_changer-linux.tar.gz\`" >> changelog.md
          printf '%s\n' "- **macOS**: \`minecraft_username_changer-macos.zip\`" >> changelog.md
          
          echo "Generated changelog:"
          cat changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag }}
          name: Release ${{ needs.create-tag.outputs.new_tag }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            artifacts/minecraft_username_changer-linux/*.tar.gz
            artifacts/minecraft_username_changer-windows/*.zip
            artifacts/minecraft_username_changer-macos/*.zip

  # Cleanup job: Delete artifacts after release
  cleanup:
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            minecraft_username_changer-linux
            minecraft_username_changer-windows
            minecraft_username_changer-macos
