name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # First job: Create a new tag
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.create_tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and create new one
        id: create_tag
        run: |
          # Get the latest tag that matches our pattern
          latest_tag=$(git tag -l 'v[0-9]*' | sort -t 'v' -k2 -n | tail -1)
          
          if [ -z "$latest_tag" ]; then
            # No tags exist yet, start with v1
            new_version=1
          else
            # Extract the number and increment
            current_version=${latest_tag#v}
            new_version=$((current_version + 1))
          fi
          
          new_tag="v${new_version}"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Creating new tag: $new_tag"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push the tag
          git tag -a "$new_tag" -m "Release $new_tag"
          git push origin "$new_tag"

  # Build job using matrix strategy
  build:
    needs: create-tag
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build-cmd: flutter build linux --release
            artifact-path: build/linux/x64/release/bundle
            artifact-name: minecraft_username_changer-linux
          - os: windows-latest
            platform: windows
            build-cmd: flutter build windows --release
            artifact-path: build/windows/x64/runner/Release
            artifact-name: minecraft_username_changer-windows
          - os: macos-latest
            platform: macos
            build-cmd: flutter build macos --release
            artifact-path: build/macos/Build/Products/Release
            artifact-name: minecraft_username_changer-macos

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Enable desktop support
        run: flutter config --enable-${{ matrix.platform }}-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build
        run: ${{ matrix.build-cmd }}

      - name: Archive Linux build
        if: matrix.platform == 'linux'
        run: |
          cd ${{ matrix.artifact-path }}
          tar -czvf ${{ github.workspace }}/${{ matrix.artifact-name }}.tar.gz *

      - name: Archive Windows build
        if: matrix.platform == 'windows'
        run: |
          cd ${{ matrix.artifact-path }}
          Compress-Archive -Path * -DestinationPath ${{ github.workspace }}/${{ matrix.artifact-name }}.zip

      - name: Archive macOS build
        if: matrix.platform == 'macos'
        run: |
          cd ${{ matrix.artifact-path }}
          zip -r ${{ github.workspace }}/${{ matrix.artifact-name }}.zip *.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ${{ matrix.artifact-name }}.tar.gz
            ${{ matrix.artifact-name }}.zip

  # Release job: Create release and upload artifacts
  release:
    needs: [create-tag, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for generating changelog

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate Changelog
        id: changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the previous tag (second to last tag)
          previous_tag=$(git tag -l 'v[0-9]*' | sort -t 'v' -k2 -n | tail -2 | head -1)
          new_tag="${{ needs.create-tag.outputs.new_tag }}"
          
          echo "Previous tag: $previous_tag"
          echo "New tag: $new_tag"
          
          # Start building the changelog
          changelog="## What's Changed"$'\n'
          
          if [ -z "$previous_tag" ] || [ "$previous_tag" = "$new_tag" ]; then
            # First release - get all merged PRs
            echo "First release, getting all merged PRs"
            prs=$(gh pr list --state merged --json number,title,author --limit 100 2>/dev/null || echo "[]")
          else
            # Get merged PRs between tags using the merge commit dates
            echo "Getting PRs merged between $previous_tag and $new_tag"
            previous_date=$(git log -1 --format=%aI "$previous_tag" 2>/dev/null || echo "")
            
            if [ -n "$previous_date" ]; then
              prs=$(gh pr list --state merged --search "merged:>=$previous_date" --json number,title,author --limit 100 2>/dev/null || echo "[]")
            else
              prs=$(gh pr list --state merged --json number,title,author --limit 100 2>/dev/null || echo "[]")
            fi
          fi
          
          # Parse PRs and build changelog
          pr_count=$(echo "$prs" | jq 'length')
          
          if [ "$pr_count" -gt 0 ] && [ "$pr_count" != "null" ]; then
            while IFS= read -r pr; do
              number=$(echo "$pr" | jq -r '.number')
              title=$(echo "$pr" | jq -r '.title')
              author=$(echo "$pr" | jq -r '.author.login')
              changelog+="* $title by @$author in #$number"$'\n'
            done < <(echo "$prs" | jq -c '.[]')
          else
            changelog+="* Direct commits to main branch"$'\n'
          fi
          
          changelog+=$'\n'"## Downloads"$'\n'
          changelog+="- **Windows**: \`minecraft_username_changer-windows.zip\`"$'\n'
          changelog+="- **Linux**: \`minecraft_username_changer-linux.tar.gz\`"$'\n'
          changelog+="- **macOS**: \`minecraft_username_changer-macos.zip\`"$'\n'
          
          # Write changelog to file to handle multi-line content
          echo "$changelog" > changelog.md
          cat changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag }}
          name: Release ${{ needs.create-tag.outputs.new_tag }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            artifacts/minecraft_username_changer-linux/*.tar.gz
            artifacts/minecraft_username_changer-windows/*.zip
            artifacts/minecraft_username_changer-macos/*.zip

  # Cleanup job: Delete artifacts after release
  cleanup:
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            minecraft_username_changer-linux
            minecraft_username_changer-windows
            minecraft_username_changer-macos
